# Cron専用Dockerコンテナ
FROM alpine:3.18

# 必要なパッケージをインストール
RUN apk add --no-cache \
    curl \
    cronie \
    tzdata \
    bash \
    && rm -rf /var/cache/apk/*

# タイムゾーンを設定（JST）
ENV TZ=Asia/Tokyo
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 作業ディレクトリを設定
WORKDIR /app

# Cronジョブの設定ファイルをコピー
COPY docker/cron/crontab /etc/crontabs/root

# Cronジョブの実行スクリプトをコピー
COPY docker/cron/run-cron.sh /usr/local/bin/
COPY docker/cron/run-notification-check.sh /usr/local/bin/
COPY docker/cron/run-cleanup.sh /usr/local/bin/
COPY docker/cron/health-check.sh /usr/local/bin/

# スクリプトに実行権限を付与
RUN chmod +x /usr/local/bin/*.sh

# ログディレクトリを作成
RUN mkdir -p /var/log/cron

# ヘルスチェックを設定
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD /usr/local/bin/health-check.sh

# Cronサービスを開始
CMD ["/bin/bash", "/usr/local/bin/run-cron.sh"]