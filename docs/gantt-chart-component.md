# ガントチャートコンポーネント仕様書

## 概要

ガントチャートコンポーネント（v2）は、プロジェクト管理アプリケーションにおけるタスクのスケジュールを視覚的に表示・編集するためのReactコンポーネントです。タスクの期間、担当者、ステータスなどを時系列で表示し、ドラッグ＆ドロップによる直感的な操作が可能です。

## 主要機能

### 1. タスクの視覚化
- タスクを時系列のバーで表示
- ステータスによる色分け（未着手：グレー、進行中：青、完了：緑）
- タスク名、担当者、期間、工数の表示
- 折りたたみ/展開による詳細表示の切り替え

### 2. インタラクティブな操作
- **ドラッグ＆ドロップ**：タスクバーをドラッグして開始日を変更
- **リサイズ**：タスクバーの両端をドラッグして期間を調整
- **クリック編集**：タスクをクリックしてモーダルで詳細編集

### 3. 表示モード
- **日表示**：1日単位で表示（最小幅60px）
- **週表示**：1週間単位で表示（最小幅80px）
- **月表示**：1ヶ月単位で表示（最小幅120px）
- **四半期表示**：3ヶ月単位で表示（最小幅120px）

### 4. グループ化機能
- **工程別**：フェーズごとにタスクをグループ化
- **担当者別**：アサインされた担当者ごとにグループ化
- **ステータス別**：タスクの進行状態ごとにグループ化
- **グループなし**：すべてのタスクを一覧表示

### 5. フィルタリング
- **ステータスフィルター**：特定のステータスのタスクのみ表示
- **担当者フィルター**：特定の担当者のタスクのみ表示

### 6. マイルストーン表示
- プロジェクトの重要な日付を赤い縦線で表示
- マイルストーン名の表示
- 表示/非表示の切り替え可能

## コンポーネント構成

### メインコンポーネント

#### 1. `gantt-v2.tsx`
メインのガントチャートコンポーネント。全体の状態管理とレイアウトを担当。

**主な責務：**
- 状態管理（表示モード、フィルター、グループ化）
- データのフェッチと更新
- 子コンポーネントへのプロップス配信
- スクロール同期の制御

#### 2. `gantt-chart.tsx`
チャート部分（右側）の描画とインタラクションを担当。

**主な機能：**
- タスクバーの描画
- ドラッグ＆ドロップ処理
- リサイズ処理
- クリックイベント処理
- グリッド線とマイルストーンの描画

#### 3. `gantt-task-list.tsx`
タスクリスト（左側）の表示を担当。

**主な機能：**
- タスク情報の表示（名前、担当者、期間、工数）
- グループヘッダーの表示
- 折りたたみ/展開機能
- タスク編集モーダルの起動

#### 4. `gantt-time-axis.tsx`
時間軸（上部）の表示を担当。

**主な機能：**
- 日付ラベルの表示
- 表示モードに応じた適切な日付フォーマット
- 今日の日付のハイライト

#### 5. `gantt-controls.tsx`
コントロールパネル（フィルター、表示設定）を担当。

**主な機能：**
- 表示モードの切り替え
- グループ化設定
- フィルター設定
- マイルストーン表示切り替え

### ユーティリティとヘルパー

#### `gantt-utils.ts`
日付計算やタスク位置計算などのユーティリティ関数を提供。

**主な関数：**
- `calculateDateRange`：プロジェクトとタスクの日付範囲を計算
- `generateTimeAxis`：時間軸の生成とチャート幅の計算
- `calculateTaskPositions`：タスクの位置と幅を計算
- `groupTasks`：タスクのグループ化
- `filterTasks`：タスクのフィルタリング
- `calculateMilestonePositions`：マイルストーンの位置計算

#### `gantt-row-constants.ts`
行の高さやスタイルに関する定数と関数を提供。

**主な定数・関数：**
- `GANTT_ROW_HEIGHTS`：各種行の高さ定数
- `calculateTaskRowHeight`：タスク情報に応じた動的高さ計算
- `getTaskBarStyleDynamic`：タスクバーのスタイル計算

## データフロー

```
┌─────────────────────┐
│   gantt-v2.tsx      │ ← データフェッチ、状態管理
└──────────┬──────────┘
           │
    ┌──────┴──────┬──────────┬─────────────┐
    │             │          │             │
┌───▼───┐  ┌─────▼────┐ ┌───▼────┐ ┌─────▼─────┐
│Controls│  │Time Axis │ │Task List│ │Chart Area │
└────────┘  └──────────┘ └─────────┘ └───────────┘
                                           │
                                     ┌─────▼─────┐
                                     │Task Modal │
                                     └───────────┘
```

## 状態管理

### グローバル状態（gantt-v2.tsx）
- `viewMode`：表示モード
- `groupBy`：グループ化設定
- `statusFilter`：ステータスフィルター
- `assigneeFilter`：担当者フィルター
- `showMilestones`：マイルストーン表示フラグ
- `collapsedGroups`：折りたたまれたグループのSet
- `collapsedTasks`：折りたたまれたタスクのSet

### ローカル状態（gantt-chart.tsx）
- `isDragging`：ドラッグ中フラグ
- `isResizing`：リサイズ中フラグ
- `draggedTask`：ドラッグ/リサイズ中のタスク
- `selectedTask`：選択されたタスク（モーダル編集用）

## インタラクション詳細

### ドラッグ＆ドロップ
1. `mousedown`イベントでクリック位置を記録
2. マウス移動が5px以上でドラッグ開始と判定
3. ドラッグ中はタスクの位置をリアルタイム更新
4. `mouseup`でサーバーに新しい日付を送信

### リサイズ
1. タスクバーの両端2pxの領域でリサイズハンドル表示
2. ハンドルのドラッグで幅を変更
3. 最小幅20pxを保証
4. リリース時に新しい期間をサーバーに送信

### スクロール同期
- タスクリストとチャートエリアの垂直スクロールを同期
- 時間軸とチャートエリアの水平スクロールを同期

## 日付処理

### UTCとローカル時間の変換
- サーバーからはUTC形式で日付を受信
- 表示時は`utcToLocalDate`でローカル時間に変換
- 保存時はローカル時間をそのまま送信（サーバー側でUTC変換）

### 日付の正規化
- 時間軸計算時は時刻を00:00:00に正規化
- これにより日付境界での位置計算の一貫性を保証

## パフォーマンス最適化

1. **React.memo**による不要な再レンダリング防止
2. **useMemo**による計算結果のメモ化
3. **useCallback**によるイベントハンドラの最適化
4. グループ単位での折りたたみによるDOM要素削減
5. 仮想スクロール実装の考慮（将来的な拡張）

## アクセシビリティ

- タスクバーに`title`属性でツールチップ表示
- キーボード操作のサポート（今後の拡張予定）
- 適切なARIAラベルの使用

## エラーハンドリング

- ドラッグ/リサイズ失敗時は元の位置に戻す
- トースト通知でユーザーにフィードバック
- サーバーエラー時の適切なエラーメッセージ表示

## テスト

### ユニットテスト
- 日付計算ロジックのテスト
- グループ化・フィルタリングロジックのテスト
- 高さ計算ロジックのテスト

### 統合テスト
- コンポーネント間の連携テスト
- ユーザーインタラクションのテスト

### E2Eテスト
- ビジュアルリグレッションテスト
- 実際の操作フローのテスト

## 今後の拡張予定

1. **依存関係の表示**：タスク間の依存関係を矢印で表示
2. **進捗率の表示**：タスクバー内に進捗率を表示
3. **リソース管理**：担当者の稼働率表示
4. **印刷対応**：ガントチャートの印刷最適化
5. **エクスポート機能**：PDF/画像形式でのエクスポート
6. **キーボード操作**：完全なキーボードナビゲーション対応