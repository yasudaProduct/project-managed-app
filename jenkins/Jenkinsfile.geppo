pipeline {
    agent any
    
    environment {
        BASE_URL = credentials('app-base-url')
        SLACK_WEBHOOK = credentials('slack-webhook-url')
    }
    
    parameters {
        choice(
            name: 'TARGET_MONTH',
            choices: [
                'auto', // è‡ªå‹•ã§å‰æœˆã‚’é¸æŠ
                '2024-12',
                '2024-11',
                '2024-10'
            ],
            description: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯¾è±¡æœˆ (YYYY-MMå½¢å¼ã€ã¾ãŸã¯autoã§å‰æœˆ)'
        )
        booleanParam(
            name: 'DRY_RUN',
            defaultValue: false,
            description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ'
        )
        booleanParam(
            name: 'SKIP_VALIDATION',
            defaultValue: false,
            description: 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—'
        )
        text(
            name: 'TARGET_PROJECTS',
            defaultValue: '',
            description: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆJSONé…åˆ—å½¢å¼ã€ç©ºã®å ´åˆã¯å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰'
        )
    }
    
    triggers {
        // æ¯æœˆ1æ—¥ã®åˆå‰2æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        cron('0 2 1 * *')
        
        // æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
        // parameterizedCron('''
        //     # æ¯æœˆ1æ—¥ã¯å‰æœˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        //     0 2 1 * * %TARGET_MONTH=auto;DRY_RUN=false;SKIP_VALIDATION=false
        // ''')
    }
    
    stages {
        stage('Preparation') {
            steps {
                script {
                    // å¯¾è±¡æœˆã®æ±ºå®š
                    if (params.TARGET_MONTH == 'auto') {
                        env.IMPORT_MONTH = sh(
                            script: "date -d 'last month' +%Y-%m",
                            returnStdout: true
                        ).trim()
                    } else {
                        env.IMPORT_MONTH = params.TARGET_MONTH
                    }
                    
                    // å¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‡¦ç†
                    if (params.TARGET_PROJECTS.trim()) {
                        try {
                            // JSONæ–‡å­—åˆ—ã®æ¤œè¨¼
                            sh "echo '${params.TARGET_PROJECTS}' | jq ."
                            env.TARGET_PROJECTS_JSON = params.TARGET_PROJECTS
                        } catch (Exception e) {
                            error("Invalid JSON format for TARGET_PROJECTS: ${e.message}")
                        }
                    } else {
                        env.TARGET_PROJECTS_JSON = 'null'
                    }
                    
                    echo "Import configuration:"
                    echo "- Target Month: ${env.IMPORT_MONTH}"
                    echo "- Dry Run: ${params.DRY_RUN}"
                    echo "- Skip Validation: ${params.SKIP_VALIDATION}"
                    echo "- Target Projects: ${env.TARGET_PROJECTS_JSON}"
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo "Performing API health check..."
                    
                    def healthResponse = httpRequest(
                        httpMode: 'GET',
                        url: "${env.BASE_URL}/api/import/geppo?targetMonth=${env.IMPORT_MONTH}",
                        validResponseCodes: '200:299,400:499'
                    )
                    
                    if (healthResponse.status >= 400) {
                        error("API health check failed with status ${healthResponse.status}")
                    }
                    
                    def healthResult = readJSON text: healthResponse.content
                    
                    if (!healthResult.success) {
                        error("API health check failed: ${healthResult.error}")
                    }
                    
                    echo "API health check passed. Available projects: ${healthResult.data.projects.size()}"
                }
            }
        }
        
        stage('Import Execution') {
            steps {
                script {
                    echo "Starting Geppo import..."
                    
                    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®æ§‹ç¯‰
                    def requestBody = [
                        targetMonth: env.IMPORT_MONTH,
                        updateMode: 'replace',
                        dryRun: params.DRY_RUN,
                        skipValidation: params.SKIP_VALIDATION
                    ]
                    
                    if (env.TARGET_PROJECTS_JSON != 'null') {
                        requestBody.targetProjectNames = readJSON text: env.TARGET_PROJECTS_JSON
                    }
                    
                    def importResponse = httpRequest(
                        httpMode: 'POST',
                        url: "${env.BASE_URL}/api/import/geppo",
                        customHeaders: [
                            [name: 'Content-Type', value: 'application/json']
                        ],
                        requestBody: writeJSON returnText: true, json: requestBody,
                        validResponseCodes: '200:299,400:499,500:599'
                    )
                    
                    def importResult = readJSON text: importResponse.content
                    
                    // çµæœã‚’Jenkinsãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿å­˜ï¼ˆé€šçŸ¥ã§ä½¿ç”¨ï¼‰
                    env.IMPORT_STATUS = importResult.success ? 'SUCCESS' : 'FAILED'
                    env.SUCCESS_COUNT = importResult.data?.successCount ?: '0'
                    env.CREATED_COUNT = importResult.data?.createdCount ?: '0'
                    env.UPDATED_COUNT = importResult.data?.updatedCount ?: '0'
                    env.ERROR_COUNT = importResult.data?.errorCount ?: '0'
                    env.EXECUTION_TIME = importResult.data?.executionTime ?: '0'
                    env.ERROR_MESSAGE = importResult.error ?: ''
                    
                    if (!importResult.success) {
                        error("Import failed: ${importResult.error}")
                    }
                    
                    echo "Import completed successfully!"
                    echo "- Success Count: ${env.SUCCESS_COUNT}"
                    echo "- Created Count: ${env.CREATED_COUNT}"
                    echo "- Updated Count: ${env.UPDATED_COUNT}"
                    echo "- Error Count: ${env.ERROR_COUNT}"
                    echo "- Execution Time: ${env.EXECUTION_TIME}ms"
                    
                    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’è¡¨ç¤º
                    if (importResult.data?.errors && importResult.data.errors.size() > 0) {
                        echo "Error details:"
                        importResult.data.errors.each { error ->
                            echo "- ${error.recordId}: ${error.message}"
                        }
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                def mode = params.DRY_RUN ? "ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³" : "æœ¬å®Ÿè¡Œ"
                def message = """
âœ… Geppoã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ (${mode})

ğŸ“… å¯¾è±¡æœˆ: ${env.IMPORT_MONTH}
ğŸ“Š çµæœ:
  â€¢ æˆåŠŸ: ${env.SUCCESS_COUNT}ä»¶
  â€¢ ä½œæˆ: ${env.CREATED_COUNT}ä»¶  
  â€¢ æ›´æ–°: ${env.UPDATED_COUNT}ä»¶
  â€¢ ã‚¨ãƒ©ãƒ¼: ${env.ERROR_COUNT}ä»¶
â± å®Ÿè¡Œæ™‚é–“: ${env.EXECUTION_TIME}ms

ğŸ”— è©³ç´°: ${env.BUILD_URL}
                """.trim()
                
                // Slacké€šçŸ¥
                if (env.SLACK_WEBHOOK) {
                    httpRequest(
                        httpMode: 'POST',
                        url: env.SLACK_WEBHOOK,
                        customHeaders: [[name: 'Content-Type', value: 'application/json']],
                        requestBody: writeJSON(returnText: true, json: [text: message])
                    )
                }
                
                // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                emailext(
                    subject: "Geppoã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ - ${env.IMPORT_MONTH}",
                    body: message,
                    to: "${env.NOTIFICATION_EMAIL ?: 'admin@company.com'}"
                )
            }
        }
        
        failure {
            script {
                def mode = params.DRY_RUN ? "ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³" : "æœ¬å®Ÿè¡Œ"
                def message = """
âŒ Geppoã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•— (${mode})

ğŸ“… å¯¾è±¡æœˆ: ${env.IMPORT_MONTH}
ğŸ’¥ ã‚¨ãƒ©ãƒ¼: ${env.ERROR_MESSAGE}

ğŸ”— ãƒ­ã‚°: ${env.BUILD_URL}console
                """.trim()
                
                // Slacké€šçŸ¥
                if (env.SLACK_WEBHOOK) {
                    httpRequest(
                        httpMode: 'POST',
                        url: env.SLACK_WEBHOOK,
                        customHeaders: [[name: 'Content-Type', value: 'application/json']],
                        requestBody: writeJSON(returnText: true, json: [text: message])
                    )
                }
                
                // ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
                emailext(
                    subject: "ğŸš¨ Geppoã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•— - ${env.IMPORT_MONTH}",
                    body: message,
                    to: "${env.ERROR_NOTIFICATION_EMAIL ?: env.NOTIFICATION_EMAIL ?: 'admin@company.com'}"
                )
            }
        }
        
        always {
            script {
                // ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ãƒ­ã‚°ã‚’ä¿å­˜
                def logContent = """
Geppo Import Job Log
====================
Build Number: ${env.BUILD_NUMBER}
Target Month: ${env.IMPORT_MONTH}
Dry Run: ${params.DRY_RUN}
Skip Validation: ${params.SKIP_VALIDATION}
Target Projects: ${env.TARGET_PROJECTS_JSON}

Results:
--------
Status: ${env.IMPORT_STATUS}
Success Count: ${env.SUCCESS_COUNT}
Created Count: ${env.CREATED_COUNT}
Updated Count: ${env.UPDATED_COUNT}
Error Count: ${env.ERROR_COUNT}
Execution Time: ${env.EXECUTION_TIME}ms
Error Message: ${env.ERROR_MESSAGE}

Build URL: ${env.BUILD_URL}
Timestamp: ${new Date()}
"""
                
                writeFile file: 'geppo-import-log.txt', text: logContent
                archiveArtifacts artifacts: 'geppo-import-log.txt', allowEmptyArchive: true
            }
        }
    }
}