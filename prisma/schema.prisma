generator client {
  provider = "prisma-client-js"
  binaryTargets   = ["native", "darwin-arm64", "linux-musl-openssl-3.0.x"]
}

generator markdown {
  provider = "prisma-markdown"
  output   = "../ERD.md"
  title    = "ER図"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Projects {
  id          String   @id @default(uuid())
  name        String
  status      ProjectStatus @default(ACTIVE)
  description String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  wbs         Wbs[]
  settings    ProjectSettings?

  @@map("projects")
}

model Users {
  id         String          @id
  email      String          @unique
  name       String
  displayName String
  password   String?         // パスワードハッシュ（オプション）
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  statusLogs TaskStatusLog[] @relation("StatusChanger")
  assignees  WbsAssignee[]   @relation("WbsAssignee")
  workRecords WorkRecord[]
  schedules  UserSchedule[]
  sessions   UserSession[]
  notifications Notification[] @relation("UserNotifications")
  notificationPreference NotificationPreference? @relation("UserNotificationPreferences")
  pushSubscriptions PushSubscription[] @relation("UserPushSubscriptions")
  importJobs ImportJob[]
  @@map("users")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_sessions")
}

model Wbs {
  id        Int        @id @default(autoincrement())
  projectId String
  name      String
  project   Projects   @relation(fields: [projectId], references: [id])
  phases    WbsPhase[]
  tasks     WbsTask[]
  assignees WbsAssignee[]
  kosus     TaskKosu[]
  buffers   WbsBuffer[]
  milestones Milestone[]
  progressHistories WbsProgressHistory[]
  taskDependencies TaskDependency[]
  importJobs ImportJob[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("wbs")
}

model WbsAssignee {
  id        Int        @id @default(autoincrement())
  wbsId     Int
  assigneeId String
  rate      Float      @default(1.0) // 参画率（0.01〜1.0）
  seq       Int        @default(0)
  wbs       Wbs        @relation(fields: [wbsId], references: [id])
  assignee  Users      @relation("WbsAssignee", fields: [assigneeId], references: [id])
  tasks     WbsTask[]  @relation("TaskAssignee")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("wbs_assignee")
}

model WbsPhase {
  id         Int       @id @default(autoincrement())
  wbsId      Int
  name       String
  code       String
  seq        Int
  wbs        Wbs       @relation(fields: [wbsId], references: [id])
  tasks      WbsTask[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("wbs_phase")
}

model PhaseTemplate {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  code      String     @unique
  seq       Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("phase_template")
}

model WbsBuffer {
  id         Int        @id @default(autoincrement())
  wbsId      Int
  name       String
  buffer     Int
  bufferType BufferType @default(OTHER)
  wbs        Wbs        @relation(fields: [wbsId], references: [id])
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("wbs_buffer")
}

model WbsTask {
  id               Int              @id @default(autoincrement())
  taskNo           String           
  wbsId            Int
  phaseId          Int?
  name             String
  assigneeId       Int?
  status           TaskStatus       @default(NOT_STARTED)
  wbs              Wbs              @relation(fields: [wbsId], references: [id])
  phase            WbsPhase?        @relation(fields: [phaseId], references: [id])
  assignee         WbsAssignee?     @relation("TaskAssignee", fields: [assigneeId], references: [id])
  statusLogs       TaskStatusLog[]  @relation("TaskStatusLogs")
  periods          TaskPeriod[]     @relation("TaskPeriod")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  workRecords      WorkRecord[]
  predecessors     TaskDependency[] @relation("PredecessorTask")
  successors       TaskDependency[] @relation("SuccessorTask")

  @@unique(fields: [taskNo,wbsId])
  @@map("wbs_task")
}

model TaskPeriod {
  id        Int        @id @default(autoincrement())
  taskId    Int
  startDate DateTime
  endDate   DateTime
  type      PeriodType
  task      WbsTask    @relation("TaskPeriod", fields: [taskId], references: [id], onDelete: Cascade)
  kosus     TaskKosu[] @relation("TaskPeriodKosu")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("task_period")
}

model TaskKosu{
  id        Int        @id @default(autoincrement())
  wbsId     Int
  periodId  Int
  kosu      Decimal
  type      KosuType
  period    TaskPeriod @relation("TaskPeriodKosu", fields: [periodId], references: [id], onDelete: Cascade)
  wbs       Wbs        @relation(fields: [wbsId], references: [id])
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("task_kosu")
}

model TaskStatusLog {
  id        Int        @id @default(autoincrement())
  taskId    Int
  status    TaskStatus
  changedAt DateTime
  changedBy String?
  task      WbsTask    @relation("TaskStatusLogs",fields: [taskId], references: [id])
  changer   Users?     @relation("StatusChanger", fields: [changedBy], references: [id])
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("task_status_log")
}

model Milestone {
  id        Int        @id @default(autoincrement())
  wbsId     Int
  name      String
  date      DateTime
  wbs       Wbs        @relation(fields: [wbsId], references: [id])
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("milestone")
}

model WorkRecord {
  id                Int        @id @default(autoincrement())
  userId            String
  taskId            Int?
  date              DateTime
  hours_worked      Decimal
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  user              Users      @relation(fields: [userId], references: [id])
  task              WbsTask?   @relation(fields: [taskId], references: [id])

  @@map("work_records")
}

model UserSchedule {
  id          Int      @id @default(autoincrement())
  userId      String
  date        DateTime
  startTime   String
  endTime     String
  title       String
  location    String?
  description String?
  user      Users    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@map("user_schedule")
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum ProjectStatus {
  INACTIVE
  ACTIVE
  DONE
  CANCELLED
  PENDING
}

enum BufferType {
  RISK
  OTHER
}

enum PeriodType {
  KIJUN
  YOTEI
  JISSEKI
}

enum KosuType {
  NORMAL
  RISK
}

model Notification {
  id            Int                  @id @default(autoincrement())
  userId        String
  type          NotificationType
  priority      NotificationPriority
  title         String
  message       String
  data          Json?                // 関連データ（タスクID、プロジェクトID等）
  channels      NotificationChannel[]
  isRead        Boolean              @default(false)
  readAt        DateTime?
  scheduledAt   DateTime?            // 予定送信時刻
  sentAt        DateTime?            // 実際の送信時刻
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  
  user          Users                @relation("UserNotifications", fields: [userId], references: [id])
  
  @@index([userId, isRead])
  @@index([scheduledAt])
  @@map("notifications")
}

model NotificationPreference {
  id                    Int      @id @default(autoincrement())
  userId                String   @unique
  enablePush            Boolean  @default(true)
  enableInApp           Boolean  @default(true)
  enableEmail           Boolean  @default(false)
  
  // 通知タイプ別の設定
  taskDeadline          Json     @default("{\"days\": [3, 1, 0]}")
  manhourThreshold      Json     @default("{\"percentages\": [80, 100, 120]}")
  scheduleDelay         Boolean  @default(true)
  taskAssignment        Boolean  @default(true)
  projectStatusChange   Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user                  Users    @relation("UserNotificationPreferences", fields: [userId], references: [id])
  
  @@map("notification_preferences")
}

model PushSubscription {
  id           Int      @id @default(autoincrement())
  userId       String
  endpoint     String
  keys         Json     // p256dh と auth キー
  userAgent    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user         Users    @relation("UserPushSubscriptions", fields: [userId], references: [id])
  
  @@unique([userId, endpoint])
  @@index([userId, isActive])
  @@map("push_subscriptions")
}

enum NotificationType {
  TASK_DEADLINE_WARNING     // タスク期限警告
  TASK_DEADLINE_OVERDUE     // タスク期限超過
  TASK_MANHOUR_WARNING      // 工数警告
  TASK_MANHOUR_EXCEEDED     // 工数超過
  TASK_ASSIGNED             // タスクアサイン
  TASK_UPDATED              // タスク更新
  SCHEDULE_DELAY            // スケジュール遅延
  PROJECT_STATUS_CHANGED    // プロジェクトステータス変更
  IMPORT_JOB_COMPLETED      // インポートジョブ成功
  IMPORT_JOB_FAILED　　　　　 // インポートジョブ失敗
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NotificationChannel {
  PUSH      // デスクトップ通知
  IN_APP    // アプリ内通知
  EMAIL     // メール通知
}

model ProjectSettings {
  projectId      String   @id
  roundToQuarter Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project        Projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_settings")
}

model WbsProgressHistory {
  id               Int      @id @default(autoincrement())
  wbsId            Int
  recordedAt       DateTime @default(now())
  recordType       RecordType
  snapshotName     String?
  totalTaskCount   Int
  completedCount   Int
  inProgressCount  Int
  notStartedCount  Int
  completionRate   Decimal
  plannedManHours  Decimal
  actualManHours   Decimal
  varianceManHours Decimal
  metadata         Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  wbs              Wbs      @relation(fields: [wbsId], references: [id])
  taskHistories    TaskProgressHistory[]
  
  @@index([wbsId, recordedAt])
  @@map("wbs_progress_history")
}

model TaskProgressHistory {
  id                    Int      @id @default(autoincrement())
  wbsProgressHistoryId  Int
  taskId                Int
  taskNo                String
  taskName              String
  status                String
  assigneeId            Int?
  assigneeName          String?
  phaseId               Int?
  phaseName             String?
  plannedStartDate      DateTime?
  plannedEndDate        DateTime?
  actualStartDate       DateTime?
  actualEndDate         DateTime?
  plannedManHours       Decimal
  actualManHours        Decimal
  progressRate          Decimal
  createdAt             DateTime @default(now())
  
  wbsProgressHistory    WbsProgressHistory @relation(fields: [wbsProgressHistoryId], references: [id])
  
  @@index([wbsProgressHistoryId])
  @@index([taskId])
  @@map("task_progress_history")
}

enum RecordType {
  AUTO
  MANUAL_SNAPSHOT
}

model TaskDependency {
  id                Int     @id @default(autoincrement())
  predecessorTaskId Int
  successorTaskId   Int
  wbsId            Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  predecessorTask  WbsTask @relation("PredecessorTask", fields: [predecessorTaskId], references: [id], onDelete: Cascade)
  successorTask    WbsTask @relation("SuccessorTask", fields: [successorTaskId], references: [id], onDelete: Cascade)
  wbs              Wbs     @relation(fields: [wbsId], references: [id], onDelete: Cascade)
  
  @@unique([predecessorTaskId, successorTaskId])
  @@index([wbsId])
  @@map("task_dependencies")
}

model SyncLog {
  id            Int       @id @default(autoincrement())
  projectId     String
  syncStatus    SyncStatus
  syncedAt      DateTime  @default(now())
  recordCount   Int       @default(0)
  addedCount    Int       @default(0)
  updatedCount  Int       @default(0)
  deletedCount  Int       @default(0)
  errorDetails  Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([projectId, syncedAt])
  @@map("sync_logs")
}

enum SyncStatus {
  SUCCESS
  FAILED
  PARTIAL
}

model CompanyHoliday {
  id        Int      @id @default(autoincrement())
  date      DateTime @db.Date
  name      String
  type      CompanyHolidayType
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@index([date])
  @@map("company_holidays")
}

enum CompanyHolidayType {
  NATIONAL
  COMPANY
  SPECIAL
}

// インポートジョブ管理
model ImportJob {
  id               String                @id @default(cuid())
  type             ImportJobType         // WBS or GEPPO
  status           ImportJobStatus       @default(PENDING)
  targetMonth      String?               // Geppo用
  targetProjectIds String[]              // 対象プロジェクトID配列
  wbsId           Int?                  // WBS用
  options         Json                  // インポートオプション
  totalRecords    Int                   @default(0)
  processedRecords Int                  @default(0)
  successCount    Int                   @default(0)
  errorCount      Int                   @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  errorDetails    Json?                 // エラー詳細
  result          Json?                 // 実行結果
  createdBy       String?               // ユーザーID（未ログインでも作成できるようNULL許容）
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  // リレーション
  user            Users?                 @relation(fields: [createdBy], references: [id])
  wbs             Wbs?                  @relation(fields: [wbsId], references: [id])
  progress        ImportJobProgress[]
  
  @@index([type, status])
  @@index([createdBy, createdAt])
  @@map("import_jobs")
}

// インポートジョブタイプ
enum ImportJobType {
  WBS
  GEPPO
}

// インポートジョブステータス
enum ImportJobStatus {
  PENDING    // 実行待ち
  RUNNING    // 実行中
  COMPLETED  // 完了
  FAILED     // 失敗
  CANCELLED  // キャンセル
}

// インポートジョブ進捗詳細
model ImportJobProgress {
  id          String      @id @default(cuid())
  jobId       String
  message     String      // 進捗メッセージ
  detail      Json?       // 詳細情報
  level       String      @default("info") // info, warning, error
  recordedAt  DateTime    @default(now())
  
  job         ImportJob   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  @@index([jobId, recordedAt])
  @@map("import_job_progress")
}