generator client {
  provider = "prisma-client-js"
  binaryTargets   = ["native", "darwin-arm64", "linux-musl-openssl-3.0.x"]
}

generator markdown {
  provider = "prisma-markdown"
  output   = "../ERD.md"
  title    = "ER図"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Projects {
  id          String        @id @default(uuid())
  name        String
  status      ProjectStatus @default(ACTIVE)
  description String?
  startDate   DateTime      @db.Date
  endDate     DateTime      @db.Date
  createdAt   DateTime      @default(now()) @db.Timestamptz
  updatedAt   DateTime      @updatedAt @db.Timestamptz
  wbs         Wbs[]
  settings    ProjectSettings?

  @@map("projects")
}

model Users {
  id         String          @id
  email      String          @unique
  name       String
  displayName String
  password   String?         
  createdAt  DateTime        @default(now()) @db.Timestamptz
  updatedAt  DateTime        @updatedAt @db.Timestamptz
  statusLogs TaskStatusLog[] @relation("StatusChanger")
  assignees  WbsAssignee[]   @relation("WbsAssignee")
  workRecords WorkRecord[]
  schedules  UserSchedule[]
  sessions   UserSession[]
  notifications Notification[]                   @relation("UserNotifications")
  notificationPreference NotificationPreference? @relation("UserNotificationPreferences")
  pushSubscriptions PushSubscription[]           @relation("UserPushSubscriptions")
  importJobs ImportJob[]
  @@map("users")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime @db.Timestamptz
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz
  user      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_sessions")
}

model Wbs {
  id        Int        @id @default(autoincrement())
  projectId String
  name      String
  project   Projects   @relation(fields: [projectId], references: [id])
  phases    WbsPhase[]
  tasks     WbsTask[]
  assignees WbsAssignee[]
  kosus     TaskKosu[]
  buffers   WbsBuffer[]
  milestones Milestone[]
  taskDependencies TaskDependency[]
  importJobs ImportJob[]
  createdAt DateTime   @default(now()) @db.Timestamptz
  updatedAt DateTime   @updatedAt @db.Timestamptz

  @@map("wbs")
}

model WbsAssignee {
  id        Int        @id @default(autoincrement())
  wbsId     Int
  assigneeId String
  rate      Float      @default(1.0) // 参画率（0.01〜1.0）
  seq       Int        @default(0)
  wbs       Wbs        @relation(fields: [wbsId], references: [id])
  assignee  Users      @relation("WbsAssignee", fields: [assigneeId], references: [id])
  tasks     WbsTask[]  @relation("TaskAssignee")
  createdAt DateTime   @default(now()) @db.Timestamptz
  updatedAt DateTime   @updatedAt @db.Timestamptz

  @@map("wbs_assignee")
}

model WbsPhase {
  id         Int       @id @default(autoincrement())
  wbsId      Int
  name       String
  code       String
  seq        Int
  wbs        Wbs       @relation(fields: [wbsId], references: [id])
  tasks      WbsTask[]
  createdAt  DateTime  @default(now()) @db.Timestamptz
  updatedAt  DateTime  @updatedAt @db.Timestamptz

  @@map("wbs_phase")
}

model PhaseTemplate {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  code      String     @unique
  seq       Int        @default(0)
  createdAt DateTime   @default(now()) @db.Timestamptz
  updatedAt DateTime   @updatedAt @db.Timestamptz

  @@map("phase_template")
}

model WbsBuffer {
  id         Int        @id @default(autoincrement())
  wbsId      Int
  name       String
  buffer     Int
  bufferType BufferType @default(OTHER)
  wbs        Wbs        @relation(fields: [wbsId], references: [id])
  createdAt  DateTime   @default(now()) @db.Timestamptz
  updatedAt  DateTime   @updatedAt @db.Timestamptz

  @@map("wbs_buffer")
}

model WbsTask {
  id               Int              @id @default(autoincrement())
  taskNo           String
  wbsId            Int
  phaseId          Int?
  name             String
  assigneeId       Int?
  status           TaskStatus       @default(NOT_STARTED)
  progressRate     Decimal?         @default(0) // 進捗率（0-100）
  wbs              Wbs              @relation(fields: [wbsId], references: [id])
  phase            WbsPhase?        @relation(fields: [phaseId], references: [id])
  assignee         WbsAssignee?     @relation("TaskAssignee", fields: [assigneeId], references: [id])
  statusLogs       TaskStatusLog[]  @relation("TaskStatusLogs")
  periods          TaskPeriod[]     @relation("TaskPeriod")
  createdAt        DateTime         @default(now()) @db.Timestamptz
  updatedAt        DateTime         @updatedAt @db.Timestamptz
  workRecords      WorkRecord[]
  predecessors     TaskDependency[] @relation("PredecessorTask")
  successors       TaskDependency[] @relation("SuccessorTask")

  @@unique(fields: [taskNo,wbsId])
  @@map("wbs_task")
}

model TaskPeriod {
  id        Int        @id @default(autoincrement())
  taskId    Int
  startDate DateTime   @db.Date
  endDate   DateTime   @db.Date
  type      PeriodType
  task      WbsTask    @relation("TaskPeriod", fields: [taskId], references: [id], onDelete: Cascade)
  kosus     TaskKosu[] @relation("TaskPeriodKosu")
  createdAt DateTime   @default(now()) @db.Timestamptz
  updatedAt DateTime   @updatedAt @db.Timestamptz

  @@map("task_period")
}

model TaskKosu{
  id        Int        @id @default(autoincrement())
  wbsId     Int
  periodId  Int
  kosu      Decimal
  type      KosuType
  period    TaskPeriod @relation("TaskPeriodKosu", fields: [periodId], references: [id], onDelete: Cascade)
  wbs       Wbs        @relation(fields: [wbsId], references: [id])
  createdAt DateTime   @default(now()) @db.Timestamptz
  updatedAt DateTime   @updatedAt @db.Timestamptz

  @@map("task_kosu")
}

model TaskStatusLog {
  id        Int        @id @default(autoincrement())
  taskId    Int
  status    TaskStatus
  changedAt DateTime   @db.Timestamptz
  changedBy String?
  task      WbsTask    @relation("TaskStatusLogs",fields: [taskId], references: [id])
  changer   Users?     @relation("StatusChanger", fields: [changedBy], references: [id])
  createdAt DateTime   @default(now()) @db.Timestamptz
  updatedAt DateTime   @updatedAt @db.Timestamptz

  @@map("task_status_log")
}

model Milestone {
  id        Int        @id @default(autoincrement())
  wbsId     Int
  name      String
  date      DateTime   @db.Timestamptz
  wbs       Wbs        @relation(fields: [wbsId], references: [id])
  createdAt DateTime   @default(now()) @db.Timestamptz
  updatedAt DateTime   @updatedAt @db.Timestamptz

  @@map("milestone")
}

model WorkRecord {
  id                Int        @id @default(autoincrement())
  userId            String
  taskId            Int?
  date              DateTime   @db.Date
  hours_worked      Decimal
  createdAt         DateTime   @default(now()) @db.Timestamptz
  updatedAt         DateTime   @updatedAt @db.Timestamptz
  user              Users      @relation(fields: [userId], references: [id])
  task              WbsTask?   @relation(fields: [taskId], references: [id])

  @@map("work_records")
}

model UserSchedule {
  id          Int      @id @default(autoincrement())
  userId      String
  date        DateTime @db.Date
  startTime   String
  endTime     String
  title       String
  location    String?
  description String?
  user      Users      @relation(fields: [userId], references: [id])
  createdAt DateTime   @default(now()) @db.Timestamptz
  updatedAt DateTime   @updatedAt @db.Timestamptz

  @@index([userId, date])
  @@map("user_schedule")
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum ProjectStatus {
  INACTIVE
  ACTIVE
  DONE
  CANCELLED
  PENDING
}

enum BufferType {
  RISK
  OTHER
}

enum PeriodType {
  KIJUN
  YOTEI
  JISSEKI
}

enum KosuType {
  NORMAL
  RISK
}

model Notification {
  id            Int                  @id @default(autoincrement())
  userId        String
  type          NotificationType
  priority      NotificationPriority
  title         String
  message       String
  data          Json?                // 関連データ（タスクID、プロジェクトID等）
  channels      NotificationChannel[]
  isRead        Boolean              @default(false)
  readAt        DateTime?            @db.Timestamptz
  scheduledAt   DateTime?            @db.Timestamptz // 予定送信時刻
  sentAt        DateTime?            @db.Timestamptz // 実際の送信時刻
  createdAt     DateTime             @default(now()) @db.Timestamptz
  updatedAt     DateTime             @updatedAt @db.Timestamptz
  
  user          Users                @relation("UserNotifications", fields: [userId], references: [id])
  
  @@index([userId, isRead])
  @@index([scheduledAt])
  @@map("notifications")
}

model NotificationPreference {
  id                    Int      @id @default(autoincrement())
  userId                String   @unique
  enablePush            Boolean  @default(true)
  enableInApp           Boolean  @default(true)
  enableEmail           Boolean  @default(false)
  
  // 通知タイプ別の設定
  taskDeadline          Json     @default("{\"days\": [3, 1, 0]}")
  manhourThreshold      Json     @default("{\"percentages\": [80, 100, 120]}")
  scheduleDelay         Boolean  @default(true)
  taskAssignment        Boolean  @default(true)
  projectStatusChange   Boolean  @default(true)
  
  createdAt             DateTime @default(now()) @db.Timestamptz
  updatedAt             DateTime @updatedAt @db.Timestamptz
  
  user                  Users    @relation("UserNotificationPreferences", fields: [userId], references: [id])
  
  @@map("notification_preferences")
}

model PushSubscription {
  id           Int      @id @default(autoincrement())
  userId       String
  endpoint     String
  keys         Json     // p256dh と auth キー
  userAgent    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz
  updatedAt    DateTime @updatedAt @db.Timestamptz
  
  user         Users    @relation("UserPushSubscriptions", fields: [userId], references: [id])
  
  @@unique([userId, endpoint])
  @@index([userId, isActive])
  @@map("push_subscriptions")
}

enum NotificationType {
  TASK_DEADLINE_WARNING     // タスク期限警告
  TASK_DEADLINE_OVERDUE     // タスク期限超過
  TASK_MANHOUR_WARNING      // 工数警告
  TASK_MANHOUR_EXCEEDED     // 工数超過
  TASK_ASSIGNED             // タスクアサイン
  TASK_UPDATED              // タスク更新
  SCHEDULE_DELAY            // スケジュール遅延
  PROJECT_STATUS_CHANGED    // プロジェクトステータス変更
  IMPORT_JOB_COMPLETED      // インポートジョブ成功
  IMPORT_JOB_FAILED　　　　　 // インポートジョブ失敗
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NotificationChannel {
  PUSH      // デスクトップ通知
  IN_APP    // アプリ内通知
  EMAIL     // メール通知
}

enum ProgressMeasurementMethod {
  ZERO_HUNDRED   // 0/100法: 完了=100%、未完了=0%
  FIFTY_FIFTY    // 50/50法: 着手=50%、完了=100%
  SELF_REPORTED  // 自己申告進捗率: wbs_task.progress_rateを使用
}

enum ForecastCalculationMethod {
  CONSERVATIVE      // 保守的：実績ベースの推定（実績工数 / 進捗率 * 100）
  REALISTIC         // 現実的：実績 + 残り予定の加重平均
  OPTIMISTIC        // 楽観的：実績 + 残り予定
  PLANNED_OR_ACTUAL // 予定/実績優先：予定 > 実績なら予定、予定 < 実績なら実績
}

model ProjectSettings {
  projectId                 String                     @id
  roundToQuarter            Boolean                    @default(false)
  progressMeasurementMethod ProgressMeasurementMethod  @default(SELF_REPORTED)
  forecastCalculationMethod ForecastCalculationMethod @default(REALISTIC)
  createdAt                 DateTime                   @default(now()) @db.Timestamptz
  updatedAt                 DateTime                   @updatedAt @db.Timestamptz

  project                   Projects                   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_settings")
}

model TaskDependency {
  id                Int     @id @default(autoincrement())
  predecessorTaskId Int
  successorTaskId   Int
  wbsId             Int
  createdAt         DateTime @default(now()) @db.Timestamptz
  updatedAt         DateTime @updatedAt @db.Timestamptz
  
  predecessorTask  WbsTask @relation("PredecessorTask", fields: [predecessorTaskId], references: [id], onDelete: Cascade)
  successorTask    WbsTask @relation("SuccessorTask", fields: [successorTaskId], references: [id], onDelete: Cascade)
  wbs              Wbs     @relation(fields: [wbsId], references: [id], onDelete: Cascade)
  
  @@unique([predecessorTaskId, successorTaskId])
  @@index([wbsId])
  @@map("task_dependencies")
}

model SyncLog {
  id            Int       @id @default(autoincrement())
  projectId     String
  syncStatus    SyncStatus
  syncedAt      DateTime  @default(now()) @db.Timestamptz
  recordCount   Int       @default(0)
  addedCount    Int       @default(0)
  updatedCount  Int       @default(0)
  deletedCount  Int       @default(0)
  errorDetails  Json?
  createdAt     DateTime  @default(now()) @db.Timestamptz
  updatedAt     DateTime  @updatedAt @db.Timestamptz

  @@index([projectId, syncedAt])
  @@map("sync_logs")
}

enum SyncStatus {
  SUCCESS
  FAILED
  PARTIAL
}

model CompanyHoliday {
  id        Int      @id @default(autoincrement())
  date      DateTime @db.Date
  name      String
  type      CompanyHolidayType
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  @@unique([date])
  @@index([date])
  @@map("company_holidays")
}

enum CompanyHolidayType {
  NATIONAL
  COMPANY
  SPECIAL
}

// インポートジョブ管理
model ImportJob {
  id               String                @id @default(cuid())
  type             ImportJobType         // WBS or GEPPO
  status           ImportJobStatus       @default(PENDING)
  targetMonth      String?               // Geppo用
  targetProjectIds String[]              // 対象プロジェクトID配列
  wbsId            Int?                  // WBS用
  options          Json                  // インポートオプション
  totalRecords     Int                   @default(0)
  processedRecords Int                   @default(0)
  successCount     Int                   @default(0)
  errorCount       Int                   @default(0)
  startedAt        DateTime?             @db.Timestamptz
  completedAt      DateTime?             @db.Timestamptz
  errorDetails     Json?                 // エラー詳細
  result           Json?                 // 実行結果
  createdBy        String?               // ユーザーID（未ログインでも作成できるようNULL許容）
  createdAt        DateTime              @default(now()) @db.Timestamptz
  updatedAt        DateTime              @updatedAt @db.Timestamptz
  
  // リレーション
  user            Users?                 @relation(fields: [createdBy], references: [id])
  wbs             Wbs?                   @relation(fields: [wbsId], references: [id])
  progress        ImportJobProgress[]
  
  @@index([type, status])
  @@index([createdBy, createdAt])
  @@map("import_jobs")
}

// インポートジョブタイプ
enum ImportJobType {
  WBS
  GEPPO
}

// インポートジョブステータス
enum ImportJobStatus {
  PENDING    // 実行待ち
  RUNNING    // 実行中
  COMPLETED  // 完了
  FAILED     // 失敗
  CANCELLED  // キャンセル
}

// インポートジョブ進捗詳細
model ImportJobProgress {
  id          String      @id @default(cuid())
  jobId       String
  message     String      // 進捗メッセージ
  detail      Json?       // 詳細情報
  level       String      @default("info")
  recordedAt  DateTime    @default(now()) @db.Timestamptz

  job         ImportJob   @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, recordedAt])
  @@map("import_job_progress")
}

// システム全体設定（シングルトン）
model SystemSettings {
  id                      Int      @id @default(1)
  standardWorkingHours    Float    @default(7.5)   // 1日の基本稼働時間
  defaultUserCostPerHour  Float?                   // デフォルト人員原価（時間単位）
  createdAt               DateTime @default(now()) @db.Timestamptz
  updatedAt               DateTime @updatedAt @db.Timestamptz

  @@map("system_settings")
}